---
title: "Selection of locations for insect monitoring in oaks"
author: "Jens Å"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  NinaR::jensAnalysis:
    highlight: tango
    fig_caption: yes
    toc: yes
---


```{r, include = F}
# Some common packages, loading rmarkdown doesn't like the messages from tidyverse, so we don't include this in the document'
require(tidyverse)
require(DBI)
require(RPostgres)
require(ggplot2)
require(xtable)
require(NinaR)
require(openxlsx)
require(tmap)
require(sf)
require(Norimon)
```


```{r setup, include=FALSE}
# This is optional
# I choose the 'styler' package for tidying the code to preserve indentations
# I set the cutoff for code tidying to 60, but this doesn't currently work with styler.
# Set tidy = True to get the knitr default
# I want all figures as png and pdf in high quality in a subfolder called figure

knitr::opts_chunk$set(
  echo = TRUE,
  tidy = "styler",
  dev = c("png", "pdf"),
  dpi = 600,
  fig.path = "figure/"
)

options(
  xtable.comment = F,
  xtable.include.rownames = F,
  nina.logo.y.pos = 0.15
)
palette(ninaPalette())
```

```{r}
connect_to_insect_db()
```



## Plan
### From Rannveig's notes.

Vi skal trekke 150 eiker (100 til overvåkingen, men må ha ekstra for å justere i forhold til logistikk, grunneiertillatelse og i felt feks om noen trær er borte) fra de 600 ARKO-eikene (657 minus «gone» og «not found» i 2019), etter følgende kriterier: 

Doblet sannsynlighet for å trekke trær med omkrets over 200 cm. 

Andel eiker i vårt utvalg speiler fordelingen blant alle ARKO-eiker; hvis det feks er 20% i Vestland, 30% i Agder, 30% i V/T, 20% i Viken, så skal overvåkingseikene fordeles etter samme andeler. 

Maks 2 overvåkingstrær per ARKO-rute. 

Da hule eiker i utgangspunktet er relativt jevnt fordelt mellom skog og åpent landskap, regner vi med at dette vil reflekteres i utvalget av overvåkingstrær uten å legge inn noe styrende kriterium for dette. Vi sjekker om vi har tilfredsstillende fordeling av eiker i skog og utenfor skog totalt og i hver region etter å ha trukket et sett overvåkingstrær. 

Etter å ha gjort et utvalg sjekker vi fordeling i forhold til ulike parametre (feks hulrom, vedmuld, barktype, treform), særlig hvor mange A-eiker som er representert.  


### Jens interpretation
I see two approaches, and will test both:
1.  We first select a fixed set of SSB-squares. These will be randomly drawn, and thereby they will be proportionally drawn from the regions depending on how many squares each region contain. Then we select max 2 trees within each location. We do this so that we get double the amount of large trees to small trees. This way, we can set the amount of localities, and if we go for 2 trees in all locations, we get 50 locations.
2.  We select trees randomly, with max 2 trees within each SSB-square. We will then get an unknown number of localities and an unknown number of localities with just a single tree.



## Load the source excel-file

```{r}

loc_raw <- openxlsx::read.xlsx("../rawData/Oak_2017data_2019resurveydata.xlsx") %>% 
  as_tibble

loc_raw
```
Filter out trees that is gone or not found in 2019.

```{r}
loc <- loc_raw %>% 
  filter(Gone != 1,
         Not_found != 1) 

nrow(loc)
```


## Selecting a fixed set of localities

How many locations have more than 2 trees anyway?

```{r}
loc %>% 
  group_by(RuteID) %>% 
  summarise(no_trees = n()) %>% 
  filter(no_trees > 1) %>% 
  summarise(n_distinct(RuteID))
  
```


```{r}
loc %>% 
  group_by(RuteID) %>% 
  summarise(no_trees = n()) %>% 
  ggplot() +
  geom_bar(aes(x = no_trees)) +
  geom_vline(aes(xintercept = 2),
             col = "red")
```





```{r}
no_rute <- loc %>% 
  summarise(no_rute = n_distinct(RuteID)) %>% 
  pull

squares <- loc %>% 
  select(RuteID) %>% 
  distinct() %>% 
  pull()
```

We have `r no_rute` distinct survey squares (SSB) to choose from.

```{r}
no_squares <- 80 #50 + 30 extra to discard if needed 

loc_square_subset <- loc %>% 
  filter(RuteID %in% sample(squares,
                            size = no_squares,
                            replace = F))

```
Apropos "double probability to draw a tree > 200 cm in circumference". This can be interpreted in several ways. There are more trees above the treshold, so a random sample will produce a higher probability anyway. Instead, I interpret it as drawing double the amount of large trees (>200cm) than smalller.

```{r}
loc %>% 
  group_by(Omkrets > 200) %>% 
  summarise(no = n())
```

Draw candidate trees

```{r}
tree_selection <- loc %>% 
  filter(!is.na(Omkrets > 200)) %>% 
  mutate(sel_prob = ifelse(Omkrets > 200, 2/3, 1/3)) %>% 
  group_by(RuteID) %>% 
  filter(n() > 1) %>% #NB, only locations with >2 trees
  slice(sample(1:n(), 2, prob = sel_prob)) %>% 
  mutate(large = Omkrets > 200)

```
```{r}
tree_selection %>% 
  ungroup() %>% 
  summarise(no_ruter = n_distinct(RuteID))
```



```{r}
tree_selection %>% 
  group_by(Omkrets > 200) %>% 
  summarise(no = n())
```

```{r}
tree_selection %>% 
  ungroup() %>% 
  summarise(no_rute = n_distinct(RuteID)) 

```

Make an SF object

```{r}

tree_sel_sf <- tree_selection %>% 
  st_as_sf(coords = c("UTM32_X_koordinat",
                      "UTM32_Y_koordinat"),
           crs = 25832)

```

Get the square geometries

```{r}
ssb_500m <- read_sf(con,
                Id(schema = "backgrounds",
                   table = "ssb_500m")) %>% 
  st_transform(crs = 25832)

sel_ssb_500m <- ssb_500m %>% 
 st_join(tree_sel_sf, 
         left = FALSE) %>% 
  select(ssbid) %>% 
  distinct()
```

```{r}
regions <- read_sf(con,
               Id(schema = "backgrounds",
                  table = "norway_terrestrial"))

south <- regions %>% 
  filter(!(navn %in% c("Trøndelag", "Nordland", "Troms og Finnmark")))
```


```{r}
#tmap_mode("view")
tm_shape(south) +
  tm_borders() +
tm_shape(sel_ssb_500m) +
  tm_borders() +
  tm_shape(tree_sel_sf) +
  tm_dots(col = "large",
             size = 0.5,
          palette = ninaPalette())
```


